<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Via Já</title>
    <!-- Inclui a biblioteca Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link para o Manifest do PWA -->
    <link rel="manifest" href="manifest.json">
    <!-- Inclui a biblioteca Leaflet CSS e JS para o mapa -->
    <!-- Importa a fonte Poppins do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha2d-pXw6E/s+dE/b+rPz/xU7T7D+o/A/6H6h/L/G/Y+J+o=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha2d-pXw6E/s+dE/b+rPz/xU7T7D+o/A/6H6h/L/G/Y+J+o=" crossorigin=""></script>
    <!-- Inclui a biblioteca de roteamento Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    
    <!-- Inclui os SDKs do Firebase necessários (App, Auth, Firestore) -->
    <!-- A inicialização do Firebase foi comentada temporariamente.
    <script type="module"> ... </script>
    -->
    
    <script>
        // Configuração do Tailwind para a fonte Inter
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        /*
        * Define as variáveis de cor padrão para o tema claro.
        * Elas são as cores de fallback, usadas por padrão.
        */
        :root {
            --bg-body: #f3f4f6;
            --bg-panel: #ffffff;
            --bg-input: #ffffff;
            --text-color: #1f2937;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
        }

        /*
        * Define as variáveis de cor para o tema escuro.
        * Elas são aplicadas quando a classe 'dark' está no body.
        */
        body.dark {
            --bg-body: lab(8.15 0.64 -11.48);
            --bg-panel: #1f2937;
            --bg-input: #1f2937;
            --text-color: #e5e7eb;
            --text-muted: #9ca3af;
            --border-color: #4a5568;
        }
        
        /* Remove o rodapé de atribuição do mapa Leaflet */
        .leaflet-control-attribution {
            display: none !important;
        }

        /* Estilos globais para a aplicação */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-color);
            padding: 1rem;
            margin: 0;
            overflow-y: auto;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .pwa-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100%;
            box-sizing: border-box;
            max-width: 600px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background-color: var(--bg-panel);
            color: var(--text-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .header-title {
            font-family: 'Poppins', sans-serif;
            letter-spacing: -0.05em; /* Espaçamento entre letras mais justo */
            font-weight: 700; /* Garante a espessura da fonte importada */
        }
        .content-panel, .ride-status-panel, .vehicle-selection-panel {
            background-color: var(--bg-panel);
            color: var(--text-color);
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .input-group {
            position: relative;
            background-color: var(--bg-input);
            padding: 0.75rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            transition: border-color 0.2s, background-color 0.2s;
        }
        .input-group.focus-within {
             border-color: #3b82f6;
             box-shadow: 0 0 0 2px #3B82F680;
        }
        .input-group input {
            width: 100%;
            background-color: transparent;
            border: none;
            outline: none;
            padding-left: 0.5rem;
        }
        .button-submit, .button-clear, .vehicle-button {
            width: 100%;
            font-weight: bold;
            padding: 0.75rem;
            border-radius: 0.75rem;
            transition: transform 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }
        .button-submit {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.4);
        }
        .button-clear {
            background-color: #e5e7eb;
            color: #4b5563;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Ajuste do tema escuro para botões de limpeza e veículos */
        body.dark .button-clear {
            background-color: #4a5568;
            color: #e2e8f0;
            box-shadow: 4px 6px rgba(0, 0, 0, 0.4);
        }
        .button-submit:hover, .button-clear:hover {
            transform: scale(1.05);
        }
        .button-submit:active, .button-clear:active {
            transform: scale(0.95);
        }
        .vehicle-button {
            flex-direction: column;
            background-color: var(--bg-input);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .vehicle-button.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #3b82f6;
        }
        .vehicle-button:hover {
            transform: scale(1.05);
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            z-index: 1000;
            text-align: center;
            display: none;
        }
        .input-group .select-in-field-button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            transition: transform 0.2s;
        }
        .input-group .select-in-field-button:hover {
            transform: scale(1.1);
        }
        .input-group .select-in-field-button svg {
            color: #3b82f6;
        }
        .motorcycle-icon {
            transform: scaleX(-1);
        }
        .message-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .map-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            z-index: 500;
            text-align: center;
            pointer-events: none;
            display: none;
            white-space: nowrap;
        }
        
        /* Estilos para notificações push */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        
        .push-notification {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #3b82f6;
            min-width: 300px;
            max-width: 400px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            pointer-events: auto;
        }
        
        .push-notification.show {
            transform: translateX(0);
        }
        
        .push-notification-info {
            border-left-color: #3b82f6;
        }
        
        .push-notification-success {
            border-left-color: #10b981;
        }
        
        .push-notification-warning {
            border-left-color: #f59e0b;
        }
        
        .push-notification-error {
            border-left-color: #ef4444;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            padding: 16px;
            gap: 12px;
        }
        
        .notification-icon {
            flex-shrink: 0;
            color: #6b7280;
        }
        
        .push-notification-info .notification-icon {
            color: #3b82f6;
        }
        
        .push-notification-success .notification-icon {
            color: #10b981;
        }
        
        .push-notification-warning .notification-icon {
            color: #f59e0b;
        }
        
        .push-notification-error .notification-icon {
            color: #ef4444;
        }
        
        .notification-text {
            flex: 1;
            color: #1f2937;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .notification-close:hover {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        
        /* Tema escuro para notificações */
        body.dark .push-notification {
            background: #1f2937;
            border-left-color: #3b82f6;
        }
        
        body.dark .push-notification-info {
            border-left-color: #60a5fa;
        }
        
        body.dark .push-notification-success {
            border-left-color: #34d399;
        }
        
        body.dark .push-notification-warning {
            border-left-color: #fbbf24;
        }
        
        body.dark .push-notification-error {
            border-left-color: #f87171;
        }
        
        body.dark .notification-text {
            color: #e5e7eb;
        }
        
        body.dark .notification-close:hover {
            background-color: #374151;
            color: #d1d5db;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .leaflet-div-icon {
            background: none;
            border: none;
        }
        .pin-blue-svg {
            color: #3b82f6;
        }
        .pin-green-svg {
            color: #22ac54;
        }
        #map-container {
            height: 0;
            opacity: 0;
            transition: height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        #map-container.visible {
            height: 60vh;
            opacity: 1;
        }
        .vehicle-price {
            font-size: 1.25rem;
            font-weight: bold;
            color: #3b82f6;
            margin-top: 0.5rem;
        }
        
        /* Estilos para o modal de login */
        #login-modal, #register-modal, #forgot-password-modal, #verify-code-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #login-modal.visible, #register-modal.visible, #forgot-password-modal.visible, #verify-code-modal.visible {
            display: flex;
        }

        .login-content {
            background-color: var(--bg-panel);
            color: var(--text-color);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }
        
        .login-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-input);
            color: var(--text-color);
        }

        .login-buttons-container {
            display: flex;
            gap: 0.5rem;
            flex-direction: column;
        }

        .modal-button {
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.2s;
            border: none;
            cursor: pointer;
        }

        .modal-button.login {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.4);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .modal-button.login:hover {
            transform: scale(1.05);
        }
        
        .modal-button.login:active {
            transform: scale(0.95);
        }

        .modal-button.register {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        
        body.dark .modal-button.register {
            background-color: #4a5568;
            color: #e2e8f0;
        }

        .autocomplete-suggestions {
            position: relative;
            z-index: 1001; /* Acima do mapa e outros elementos */
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 0.25rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none; /* Inicialmente oculto */
        }
        .autocomplete-suggestions div {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        .autocomplete-suggestions div:last-child {
            border-bottom: none;
        }
        .autocomplete-suggestions div:hover {
            background-color: #3b82f6;
            color: white;
        }

    </style>
</head>
<body class="pwa-container">
    <!-- Modal de Login -->
    <div id="login-modal">
        <div class="login-content">
            <button id="close-modal-button" class="close-modal">&times;</button>
            <h2 class="text-xl font-bold text-center">Entrar</h2>
            <input id="login-phone" type="tel" placeholder="Telefone" class="login-input">
            <input id="login-password" type="password" placeholder="Senha" class="login-input">
            <a href="#" id="forgot-password-link" class="text-sm text-blue-500 hover:underline text-right -mt-2 mb-2">Esqueci minha senha</a>
            <div class="login-buttons-container">
                <button id="login-button" class="modal-button login">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                        <polyline points="10,17 15,12 10,7"/>
                        <line x1="15" y1="12" x2="3" y2="12"/>
                    </svg>
                    Entrar
                </button>
                <button id="go-to-register-button" class="modal-button register">Criar Conta</button>
            </div>
            <p id="login-error-message" class="text-red-500 text-sm text-center"></p>
        </div>
    </div>

    <!-- Modal de Cadastro (Novo) -->
    <div id="register-modal">
        <div class="login-content">
            <button id="close-register-modal-button" class="close-modal">&times;</button>
            <h2 class="text-xl font-bold text-center">Criar Nova Conta</h2>
            <input id="register-name" type="text" placeholder="Nome completo" class="login-input">
            <input id="register-phone" type="tel" placeholder="Telefone" class="login-input">
            <input id="register-password" type="password" placeholder="Senha (mín. 6 caracteres)" class="login-input">
            <input id="register-confirm-password" type="password" placeholder="Confirmar Senha" class="login-input">
            <div class="login-buttons-container">
                <button id="create-account-button" class="modal-button login">Criar Conta</button>
                <button id="back-to-login-button" class="modal-button register">Já tenho uma conta</button>
            </div>
            <p id="register-error-message" class="text-red-500 text-sm text-center"></p>
        </div>
    </div>

    <!-- Modal de Esqueci a Senha -->
    <div id="forgot-password-modal">
        <div class="login-content">
            <button id="close-forgot-modal-button" class="close-modal">&times;</button>
            <h2 class="text-xl font-bold text-center">Recuperar Senha</h2>
            <p class="text-sm text-center text-gray-600 dark:text-gray-400">Digite seu número de telefone para receber um código de recuperação.</p>
            <input id="forgot-phone" type="tel" placeholder="Telefone" class="login-input">
            <div class="login-buttons-container">
                <button id="send-code-button" class="modal-button login">Enviar Código</button>
                <button id="back-to-login-from-forgot-button" class="modal-button register">Voltar para o Login</button>
            </div>
            <p id="forgot-error-message" class="text-red-500 text-sm text-center"></p>
        </div>
    </div>

    <!-- Modal de Verificação de Código e Redefinição de Senha -->
    <div id="verify-code-modal">
        <div class="login-content">
            <button id="close-verify-modal-button" class="close-modal">&times;</button>
            <h2 class="text-xl font-bold text-center">Redefinir Senha</h2>
            <p class="text-sm text-center text-gray-600 dark:text-gray-400">Um código foi enviado para o seu telefone. Insira-o abaixo para redefinir sua senha.</p>
            <input id="verify-code-input" type="text" placeholder="Código de 6 dígitos" class="login-input" maxlength="6">
            <input id="new-password-input" type="password" placeholder="Nova Senha" class="login-input">
            <input id="confirm-new-password-input" type="password" placeholder="Confirmar Nova Senha" class="login-input">
            <div class="login-buttons-container">
                <button id="reset-password-button" class="modal-button login">Redefinir Senha</button>
                <button id="back-to-login-from-verify-button" class="modal-button register">Voltar para o Login</button>
            </div>
            <p id="verify-error-message" class="text-red-500 text-sm text-center"></p>
        </div>
    </div>
    
    <!-- Cabeçalho -->
    <header class="header flex-shrink-0 mb-4">
        <!-- Título que agora herda a cor do cabeçalho pai -->
        <h1 class="text-xl md:text-2xl font-bold flex items-center gap-2 header-title">
            <img src="logo.png" alt="Logo Via Já" class="w-8 h-8">
            Via Já
        </h1>
        <div class="flex items-center gap-4">
             <!-- Botão de alternância de tema -->
            <button id="theme-toggle" class="flex items-center space-x-2 text-sm p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                </svg>
            </button>
            <!-- Botão de login/perfil -->
            <button id="auth-button" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition transform hover:scale-105">
                <span id="auth-text">Entrar</span>
            </button>
        </div>
    </header>

    <!-- Container do mapa -->
    <div id="map-container" class="relative">
        <div id="map" class="h-full w-full rounded-xl"></div>
        <div id="map-message" class="map-message">Toque no mapa para selecionar o local</div>
    </div>

    <!-- Painéis de conteúdo dinâmicos -->
    <main class="flex-grow flex flex-col justify-start gap-4 mt-4">
        <!-- Painel de formulário inicial -->
        <div id="ride-request-panel" class="content-panel">
            <form id="ride-request-form" class="ride-request-form">
                <div class="input-group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pin-blue-svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                    </svg>
                    <input id="origin-input" type="text" placeholder="Origem" autocomplete="off">
                    <div class="flex items-center gap-2">
                        <button type="button" id="current-location-button" class="select-in-field-button" title="Usar localização atual">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
                            </svg>
                        </button>
                        <button type="button" id="select-origin-button" class="select-in-field-button" title="Selecionar no mapa">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pin-blue-svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="origin-suggestions" class="autocomplete-suggestions"></div>
                <div class="input-group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pin-green-svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                    </svg>
                    <input id="destination-input" type="text" placeholder="Destino" autocomplete="off">
                    <button type="button" id="select-destination-button" class="select-in-field-button" title="Selecionar no mapa">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pin-green-svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div id="destination-suggestions" class="autocomplete-suggestions"></div>
                <div id="route-info-display" class="text-center font-semibold text-gray-700 dark:text-gray-300 my-2 hidden"></div>
                <button type="button" id="clear-button" class="button-clear">Limpar</button>
                <button type="button" id="submit-button" class="button-submit" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    Solicitar corrida
                </button>
            </form>
        </div>

        <!-- Painel de seleção de veículo (inicialmente oculto) -->
        <div id="vehicle-selection-panel" class="vehicle-selection-panel hidden">
            <h2 class="text-xl font-bold mb-2 text-center">Selecione o tipo de veículo</h2>
            <div id="trip-info" class="text-center text-sm text-gray-500 mb-4">
                <p id="estimated-distance-time"></p>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button type="button" class="vehicle-button" data-vehicle="Moto">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 motorcycle-icon">
                        <path d="M2.5 13.5L4 12c.5-1.5 2-2.5 3.5-2.5H16c1 0 2 .5 2.5 1l.5 1.5c.5.5.5 1.5 0 2l-1 1c-.5.5-1.5 1-2 1H7.5c-1.5 0-3-.5-4-1.5L2.5 13.5zM18.5 18a3 3 0 100-6 3 3 0 000 6zM6 18a3 3 0 100-6 3 3 0 000 6z"/>
                    </svg>
                    Moto
                    <span class="vehicle-price"></span>
                </button>
                <button type="button" class="vehicle-button" data-vehicle="Carro">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <path d="M10 2l-2 2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-4l-2-2zM4 12h16M4 18h16"></path><circle cx="8" cy="14" r="2"></circle><circle cx="16" cy="14" r="2"></circle>
                    </svg>
                    Carro
                    <span class="vehicle-price"></span>
                </button>
                <button type="button" class="vehicle-button" data-vehicle="Lotação">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <path d="M18 10l-4-4h-4l-4 4"></path><path d="M18 10v4l-4 4h-4l-4-4v-4"></path><path d="M12 6l-4 4-4-4"></path><path d="M12 18l4-4 4 4"></path><path d="M20 12l-8-8-8 8"></path><path d="M4 12v6l8 4 8-4v-6"></path><line x1="12" y1="18" x2="12" y2="22"></line>
                    </svg>
                    Lotação
                    <span class="vehicle-price"></span>
                </button>
                <button type="button" class="vehicle-button" data-vehicle="Entrega">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <path d="M2 13.5l1.5-1.5c1-1 2.5-1.5 4-1.5h10c1.5 0 3 1 3.5 2.5l1 1c.5.5.5 1.5 0 2l-1 1c-.5.5-1.5 1-2 1h-10c-1.5 0-3-.5-4-1.5l-1-1.5zM19 18a3 3 0 100-6 3 3 0 000 6zM6 18a3 3 0 100-6 3 3 0 000 6z"/>
                    </svg>
                    Entrega
                    <span class="vehicle-price"></span>
                </button>
            </div>
            <button id="back-to-form-button" class="mt-4 button-clear">Voltar</button>
        </div>

        <!-- Painel de status da corrida (inicialmente oculto) -->
        <div id="ride-status-panel" class="ride-status-panel hidden">
            <div class="flex flex-col items-center">
                <div id="loader" class="loader mb-4"></div>
                <p id="status-message" class="text-lg font-semibold mb-2 text-center"></p>
                <div class="mt-4 text-center text-sm text-gray-500">
                    <p id="status-distance" class="font-medium mb-2"></p>
                    <p id="status-price" class="font-medium text-lg text-blue-500"></p>
                    <!-- ENDEREÇO DE ORIGEM (CORRIGIDO) -->
                    <p id="status-origin" class="font-medium flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pin-blue-svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                        <span id="status-origin-text"></span>
                    </p>
                    <!-- ENDEREÇO DE DESTINO (CORRIGIDO) -->
                    <p id="status-destination" class="font-medium flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pin-green-svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                        <span id="status-destination-text"></span>
                    </p>
                </div>
                <button id="cancel-button" class="mt-6 button-clear">Cancelar</button>
            </div>
        </div>
    </main>

    <!-- Rodapé -->
    <footer class="mt-auto py-4 text-center text-xs text-gray-500">
       Via Já - Todos os Direitos Reservados ®
    </footer>

    <!-- Caixa de mensagem flutuante -->
    <div id="message-box" class="message-box"></div>

    <script>
        // Variáveis globais
        let map;
        let originMarker, destinationMarker;
        let routeControl;
        let currentOrigin = null;
        let currentDestination = null;
        let currentSelectionMode = null;
        let mapMessageTimeout;
        let tripData = {
            distance: 0,
            time: 0,
            fare: 0,
            vehicle: ''
        };
        
        // Coordenadas padrão para Patos de Minas, MG
        const defaultCoords = [-18.5807, -46.5160];

        // Mapeamento de elementos do DOM
        const dom = {
            mapContainer: document.getElementById('map-container'),
            rideRequestPanel: document.getElementById('ride-request-panel'),
            vehicleSelectionPanel: document.getElementById('vehicle-selection-panel'),
            rideStatusPanel: document.getElementById('ride-status-panel'),
            originInput: document.getElementById('origin-input'),
            destinationInput: document.getElementById('destination-input'),
            originSuggestions: document.getElementById('origin-suggestions'),
            destinationSuggestions: document.getElementById('destination-suggestions'),
            submitButton: document.getElementById('submit-button'),
            clearButton: document.getElementById('clear-button'),
            currentLocationButton: document.getElementById('current-location-button'),
            selectOriginButton: document.getElementById('select-origin-button'),
            selectDestinationButton: document.getElementById('select-destination-button'),
            messageBox: document.getElementById('message-box'),
            mapMessage: document.getElementById('map-message'),
            vehicleButtons: document.querySelectorAll('.vehicle-button'),
            backToFormButton: document.getElementById('back-to-form-button'),
            statusMessage: document.getElementById('status-message'),
            statusDistance: document.getElementById('status-distance'),
            statusPrice: document.getElementById('status-price'),
            statusOriginText: document.getElementById('status-origin-text'), 
            statusDestinationText: document.getElementById('status-destination-text'), 
            cancelButton: document.getElementById('cancel-button'),
            estimatedDistanceTimeEl: document.getElementById('estimated-distance-time'),
            routeInfoDisplay: document.getElementById('route-info-display'),
            themeToggle: document.getElementById('theme-toggle'),
            authButton: document.getElementById('auth-button'),
            authText: document.getElementById('auth-text'),
            
            // Novos elementos do modal
            loginModal: document.getElementById('login-modal'),
            closeModalButton: document.getElementById('close-modal-button'),
            loginPhoneInput: document.getElementById('login-phone'), // Corrigido para corresponder ao ID
            loginPasswordInput: document.getElementById('login-password'),
            loginButton: document.getElementById('login-button'),
            goToRegisterButton: document.getElementById('go-to-register-button'),
            loginErrorMessage: document.getElementById('login-error-message'),

            // Register Modal (New)
            registerModal: document.getElementById('register-modal'),
            closeRegisterModalButton: document.getElementById('close-register-modal-button'),
            registerNameInput: document.getElementById('register-name'),
            registerPhoneInput: document.getElementById('register-phone'),
            registerPasswordInput: document.getElementById('register-password'),
            registerConfirmPasswordInput: document.getElementById('register-confirm-password'),
            createAccountButton: document.getElementById('create-account-button'),
            backToLoginButton: document.getElementById('back-to-login-button'),
            registerErrorMessage: document.getElementById('register-error-message'),

            // Forgot Password Modal (New)
            forgotPasswordLink: document.getElementById('forgot-password-link'),
            forgotPasswordModal: document.getElementById('forgot-password-modal'),
            closeForgotModalButton: document.getElementById('close-forgot-modal-button'),
            forgotPhoneInput: document.getElementById('forgot-phone'),
            sendCodeButton: document.getElementById('send-code-button'),
            backToLoginFromForgotButton: document.getElementById('back-to-login-from-forgot-button'),
            forgotErrorMessage: document.getElementById('forgot-error-message'),

            // Verify Code Modal (New)
            verifyCodeModal: document.getElementById('verify-code-modal'),
            closeVerifyModalButton: document.getElementById('close-verify-modal-button'),
            verifyCodeInput: document.getElementById('verify-code-input'),
            newPasswordInput: document.getElementById('new-password-input'),
            confirmNewPasswordInput: document.getElementById('confirm-new-password-input'),
            resetPasswordButton: document.getElementById('reset-password-button'),
            backToLoginFromVerifyButton: document.getElementById('back-to-login-from-verify-button'),
            verifyErrorMessage: document.getElementById('verify-error-message')
        };
        
        // Definição das tarifas de transporte
        const vehicleRates = {
            'Moto': { base: 6.00, perKm: 1.50, minFare: 8.00 },
            'Carro': { base: 8.00, perKm: 2.50, minFare: 12.00 },
            'Lotação': { base: 5.00, perKm: 1.00, minFare: 7.00 },
            'Entrega': { base: 7.00, perKm: 2.00, minFare: 10.00 }
        };

        /**
         * Alterna entre o tema claro e escuro e salva a preferência.
         */
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            // Alterna a logo baseado no tema
            const logoElement = document.querySelector('h1 img');
            if (logoElement) {
                logoElement.src = isDark ? 'logodark.png' : 'logo.png';
                logoElement.alt = isDark ? 'Logo Via Já (Tema Escuro)' : 'Logo Via Já';
            }
        }

        /**
         * Formata o objeto de local da API para uma string simplificada e legível.
         * @param {object} place - O objeto de local completo retornado pela API Nominatim.
         * @returns {string} Uma string de endereço formatada e limpa, ou uma string vazia.
         */
        function formatPlaceForDisplay(place) {
            if (!place || !place.address) return '';
            
            const address = place.address;
            const finalParts = [];

            // 1. Nome do Ponto de Interesse (POI) ou nome do edifício
            const poiName = place.name || address.tourism || address.amenity || address.shop || address.office || address.building;
            if (poiName) {
                finalParts.push(poiName);
            }

            // 2. Rua e Número (adiciona se não for redundante com o nome do POI)
            const road = address.road || '';
            const houseNumber = address.house_number || '';
            if (road && road.toLowerCase() !== (poiName || '').toLowerCase()) {
                finalParts.push(road + (houseNumber ? `, ${houseNumber}` : ''));
            }

            // 3. Bairro
            const suburb = address.suburb || address.city_district || '';
            if (suburb) {
                finalParts.push(suburb);
            }

            // 4. Cidade e Estado
            const city = address.city || address.town || address.village || '';
            const state = address.state || '';
            if (city) {
                finalParts.push(city + (state ? ` - ${state}` : ''));
            } else if (state) {
                finalParts.push(state);
            }

            // Remove duplicatas (ex: bairro com mesmo nome da cidade) e junta.
            return [...new Set(finalParts)].join(', ');
        }

        /**
         * Debounce function to limit the rate at which a function gets called.
         * @param {Function} func The function to debounce.
         * @param {number} delay The delay in milliseconds.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        /**
         * Busca e exibe sugestões de endereço.
         * @param {HTMLInputElement} inputEl - O elemento de input.
         * @param {HTMLDivElement} suggestionsEl - O container para as sugestões.
         */
        async function fetchAndDisplaySuggestions(inputEl, suggestionsEl) {
            const query = inputEl.value;
            if (query.length < 3) {
                suggestionsEl.innerHTML = '';
                suggestionsEl.style.display = 'none';
                return;
            }

            // Usando a API de busca do Nominatim (OpenStreetMap)
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=br&limit=5`;

            try {
                const response = await fetch(url);
                const results = await response.json();

                suggestionsEl.innerHTML = '';
                if (results && results.length > 0) {
                    results.forEach(place => {
                        const suggestionDiv = document.createElement('div');
                        const displayAddress = formatPlaceForDisplay(place) || place.display_name.split(',').slice(0,3).join(',');
                        suggestionDiv.textContent = displayAddress;
                        
                        suggestionDiv.addEventListener('click', () => {
                            inputEl.value = displayAddress;
                            place.display_name = displayAddress; // Atualiza para consistência
                            suggestionsEl.innerHTML = '';
                            suggestionsEl.style.display = 'none'; // Limpa e esconde a lista
                            
                            const latlng = { lat: parseFloat(place.lat), lng: parseFloat(place.lon) };

                            if (inputEl.id === 'origin-input') {
                                currentOrigin = { latlng, data: place }; 
                                addOrMoveMarker(latlng, 'origin', 'Origem');
                            } else {
                                currentDestination = { latlng, data: place };
                                addOrMoveMarker(latlng, 'destination', 'Destino');
                            }

                            if (currentOrigin && currentDestination) {
                                traceRoute();
                                dom.submitButton.disabled = false;
                            }
                            
                            if (!dom.mapContainer.classList.contains('visible')) {
                                toggleMapVisibility(true);
                            }
                        });

                        suggestionsEl.appendChild(suggestionDiv);
                    });
                    suggestionsEl.style.display = 'block';
                } else {
                    suggestionsEl.innerHTML = '';
                    suggestionsEl.style.display = 'none'; // Limpa e esconde se não houver resultados
                }
            } catch (error) {
                console.error('Erro ao buscar sugestões de endereço:', error);
                suggestionsEl.innerHTML = '';
                suggestionsEl.style.display = 'none'; // Limpa e esconde em caso de erro
            }
        }

        /**
         * Exibe uma mensagem flutuante temporária.
         * @param {string} message - A mensagem a ser exibida.
         */
        function showMessage(message) {
            dom.messageBox.textContent = message;
            dom.messageBox.style.display = 'block';
            setTimeout(() => {
                dom.messageBox.style.display = 'none';
            }, 3000);
        }

        /**
         * Exibe ou oculta o contêiner do mapa.
         * @param {boolean} visible - Se o mapa deve ser visível.
         */
        function toggleMapVisibility(visible) {
            dom.mapContainer.classList.toggle('visible', visible);
            if (visible) {
                // Invalida o tamanho do mapa para garantir que ele seja exibido corretamente
                setTimeout(() => map.invalidateSize(), 500);
            } else {
                 dom.mapMessage.style.display = 'none';
                 clearTimeout(mapMessageTimeout);
            }
        }
        
        /**
         * Exibe uma notificação push moderna e elegante.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} type - Tipo da notificação ('info', 'success', 'warning', 'error').
         * @param {number} duration - Duração em milissegundos.
         */
        function showPushNotification(message, type = 'info', duration = 4000) {
            // Cria o elemento da notificação
            const notification = document.createElement('div');
            notification.className = `push-notification push-notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">
                        ${getNotificationIcon(type)}
                    </div>
                    <div class="notification-text">${message}</div>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;
            
            // Adiciona ao container de notificações
            const container = document.getElementById('notification-container') || createNotificationContainer();
            container.appendChild(notification);
            
            // Animação de entrada
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Remove automaticamente após a duração especificada
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }
        
        /**
         * Cria o container de notificações se não existir.
         */
        function createNotificationContainer() {
            const container = document.createElement('div');
            container.id = 'notification-container';
            container.className = 'notification-container';
            document.body.appendChild(container);
            return container;
        }
        
        /**
         * Retorna o ícone apropriado para cada tipo de notificação.
         */
        function getNotificationIcon(type) {
            const icons = {
                info: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16v-4M12 8h.01"/>
                </svg>`,
                success: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22,4 12,14 9,11"/>
                </svg>`,
                warning: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>`,
                error: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>`
            };
            return icons[type] || icons.info;
        }

        /**
         * Alterna o painel de visualização principal.
         * @param {string} panelId - O ID do painel a ser exibido ('ride-request-panel', 'vehicle-selection-panel' ou 'ride-status-panel').
         */
        function switchPanel(panelId) {
            dom.rideRequestPanel.classList.add('hidden');
            dom.vehicleSelectionPanel.classList.add('hidden');
            dom.rideStatusPanel.classList.add('hidden');
            document.getElementById(panelId).classList.remove('hidden');
        }

        /**
         * Inicializa o mapa com as coordenadas fornecidas.
         * @param {number} lat - Latitude inicial.
         * @param {number} lng - Longitude inicial.
         */
        function initializeMap(lat, lng) {
            if (map) {
                map.remove();
            }
            map = L.map('map').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', handleMapClick);
        }
        
        /**
         * Atualiza a visão do mapa e o marcador de origem.
         * @param {number} lat - Latitude.
         * @param {number} lng - Longitude.
         * @param {string} name - Nome para o marcador.
         */
        function updateUserLocation(lat, lng, name = 'Sua Localização') {
            const coords = [lat, lng];
            map.setView(coords, 16);
            if (!originMarker) {
                 const markerHtml = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-8 h-8 ${pinClass}">
                                         <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                     </svg>`;
                 const customIcon = L.divIcon({
                     html: markerHtml,
                     className: 'leaflet-div-icon',
                     iconSize: [20, 20],
                     iconAnchor: [10, 20]
                 });
                 originMarker = L.marker(coords, { icon: customIcon }).addTo(map).bindTooltip(name, { permanent: false, direction: 'top' });
            } else {
                 originMarker.setLatLng(coords);
            }
            
            // Define a localização atual como a origem
            currentOrigin = { latlng: { lat: lat, lng: lng }, data: { address: { road: name } } };
            dom.originInput.value = name;
        }

        /**
         * Obtém o endereço de uma coordenada usando geocodificação reversa.
         * @param {number} lat - Latitude.
         * @param {number} lng - Longitude.
         * @returns {Promise<object>} O objeto de dados completo da API de geocodificação ou um objeto de erro.
         */
        async function reverseGeocode(lat, lng) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro na geocodificação reversa:', error);
                return { error: 'Endereço desconhecido', address: {} };
            }
        }
        
        /**
         * Adiciona ou move um marcador no mapa.
         * @param {object} coords - Coordenadas do marcador.
         * @param {string} type - Tipo de marcador ('origin' ou 'destination').
         * @param {string} name - Nome para a tooltip do marcador.
         */
        function addOrMoveMarker(coords, type, name) {
            let marker = (type === 'origin') ? originMarker : destinationMarker;
            
            if (marker) {
                // Se o marcador já existe, apenas move
                marker.setLatLng(coords);
            } else {
                // Se não existe, cria um novo
                const pinClass = type === 'origin' ? 'pin-blue-svg' : 'pin-green-svg';
                const markerHtml = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-8 h-8 ${pinClass}">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                    </svg>`;
                const customIcon = L.divIcon({
                    html: markerHtml,
                    className: 'leaflet-div-icon',
                    iconSize: [20, 20],
                    iconAnchor: [10, 20]
                });
                marker = L.marker(coords, { icon: customIcon }).addTo(map).bindTooltip(name, { permanent: false, direction: 'top' });

                if (type === 'origin') {
                    originMarker = marker;
                } else {
                    destinationMarker = marker;
                }
            }
        }

        /**
         * Formata segundos em uma string de tempo legível (ex: "15 min").
         * @param {number} totalSeconds - O tempo total em segundos.
         * @returns {string} O tempo formatado.
         */
        function formatTime(totalSeconds) {
            if (totalSeconds < 60) {
                return "< 1 min";
            }
            const minutes = Math.round(totalSeconds / 60);
            if (minutes < 60) {
                return `${minutes} min`;
            }
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            if (remainingMinutes === 0) {
                return `${hours} h`;
            }
            return `${hours} h ${remainingMinutes} min`;
        }


        /**
         * Estima a tarifa com base na distância e no tipo de veículo.
         * @param {number} distanceKm - Distância em quilômetros.
         * @param {string} vehicleType - Tipo de veículo.
         * @returns {string} Preço formatado em R$.
         */
        function estimateFare(distanceKm, vehicleType) {
            const rates = vehicleRates[vehicleType];
            if (!rates) return "R$ --";
            
            const totalFare = rates.base + (distanceKm * rates.perKm);
            const finalFare = Math.max(totalFare, rates.minFare);
            return `R$ ${finalFare.toFixed(2).replace('.', ',')}`;
        }

        /**
         * Traça uma rota entre a origem e o destino no mapa.
         */
        function traceRoute() {
            if (routeControl) {
                map.removeControl(routeControl);
            }
            if (currentOrigin && currentDestination) {
                // Configura o controle de roteamento usando o serviço padrão OSRM (não requer API Key)
                routeControl = L.Routing.control({
                    waypoints: [
                        L.latLng(currentOrigin.latlng.lat, currentOrigin.latlng.lng),
                        L.latLng(currentDestination.latlng.lat, currentDestination.latlng.lng)
                    ],
                    lineOptions: {
                        styles: [{color: '#3b82f6', weight: 6, opacity: 0.7}]
                    },
                    createMarker: function() { return null; }, // Desabilita a criação de marcadores padrão
                    show: false,
                    addWaypoints: false,
                    routeWhileDragging: true
                }).addTo(map);

                // Opcional: ajustar o zoom para a rota
                routeControl.on('routesfound', function(e) {
                    const route = e.routes[0];
                    const distanceMeters = route.summary.totalDistance;
                    const timeSeconds = route.summary.totalTime;

                    tripData.distance = distanceMeters / 1000; // Converte para KM
                    tripData.time = timeSeconds;

                    const formattedTime = formatTime(timeSeconds);
                    const routeInfoText = `Distância: ${tripData.distance.toFixed(2)} km | Tempo Aprox.: ${formattedTime}`;
                    
                    dom.routeInfoDisplay.textContent = routeInfoText;
                    dom.routeInfoDisplay.classList.remove('hidden');
                    dom.estimatedDistanceTimeEl.textContent = routeInfoText;
                    
                    // Atualiza os preços para cada botão de veículo
                    dom.vehicleButtons.forEach(button => {
                        const vehicleType = button.dataset.vehicle;
                        const price = estimateFare(tripData.distance, vehicleType);
                        button.querySelector('.vehicle-price').textContent = price;
                    });
                    
                    map.fitBounds(route.coordinates, { padding: [50, 50] });
                });
            }
        }

        /**
         * Limpa o formulário e o mapa.
         */
        function clearFieldsAndMap() {
            currentOrigin = null;
            currentDestination = null;
            dom.originInput.value = '';
            dom.destinationInput.value = '';
            dom.submitButton.disabled = true;
            tripData.distance = 0;
            tripData.time = 0;
            tripData.fare = 0;
            tripData.vehicle = '';
            dom.estimatedDistanceTimeEl.textContent = '';
            dom.routeInfoDisplay.textContent = '';
            dom.routeInfoDisplay.classList.add('hidden');
            
            dom.vehicleButtons.forEach(button => {
                button.querySelector('.vehicle-price').textContent = '';
            });

            if (originMarker) map.removeLayer(originMarker);
            if (destinationMarker) map.removeLayer(destinationMarker);
            if (routeControl) map.removeControl(routeControl);

            originMarker = null;
            destinationMarker = null;
            routeControl = null;
            
            // Oculta o mapa ao limpar
            toggleMapVisibility(false);
        }

        /**
         * Lida com cliques no mapa para selecionar origem/destino.
         * @param {object} e - Objeto do evento do clique.
         */
        async function handleMapClick(e) {
            if (!currentSelectionMode) return;
            
            const latlng = e.latlng;
            const fullAddressData = await reverseGeocode(latlng.lat, latlng.lng);
            const addressText = formatPlaceForDisplay(fullAddressData) || 'Endereço desconhecido';

            if (currentSelectionMode === 'origin') {
                fullAddressData.display_name = addressText; // Atualiza para consistência
                currentOrigin = { latlng: latlng, data: fullAddressData };
                dom.originInput.value = addressText;
                addOrMoveMarker(currentOrigin.latlng, 'origin', 'Origem'); // MODIFICADO
            } else if (currentSelectionMode === 'destination') {
                fullAddressData.display_name = addressText; // Atualiza para consistência
                currentDestination = { latlng: latlng, data: fullAddressData };
                dom.destinationInput.value = addressText;
                addOrMoveMarker(currentDestination.latlng, 'destination', 'Destino'); // MODIFICADO
            }
            
            // Não limpa o modo de seleção para permitir múltiplos cliques
            // currentSelectionMode = null; 
            
            if (currentOrigin && currentDestination) {
                traceRoute();
                dom.submitButton.disabled = false;
            }
        }

        /**
         * Lida com a seleção de localização do usuário.
         */
        function handleCurrentLocation() {
           // showPushNotification("Obtendo sua localização...", "info", 2000);
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;

                    // 1. Torna o mapa visível assim que a localização for obtida
                    toggleMapVisibility(true);

                    const fullAddressData = await reverseGeocode(latitude, longitude);
                    const addressText = formatPlaceForDisplay(fullAddressData) || 'Sua Localização';
 
                    fullAddressData.display_name = addressText; // Atualiza para consistência
                    currentOrigin = { latlng: { lat: latitude, lng: longitude }, data: fullAddressData };
                    dom.originInput.value = addressText;

                    // 2. Usa um ícone de "alvo" para a localização atual
                    const targetIconHtml = `<svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-blue-500 animate-pulse" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>`;
                    const targetIcon = L.divIcon({
                        html: targetIconHtml,
                        className: 'leaflet-div-icon',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    if (originMarker) map.removeLayer(originMarker);
                    originMarker = L.marker(currentOrigin.latlng, { icon: targetIcon }).addTo(map);

                    map.setView([latitude, longitude], 16);
                    if (currentDestination) {
                        traceRoute();
                    }
                    dom.submitButton.disabled = !currentDestination;
                    showPushNotification("Localização atual definida como origem", "success", 3000);
                },
                (error) => {
                    console.error("Erro ao obter a localização: ", error);
                    let message = "Não foi possível obter sua localização. Verifique as permissões do navegador.";
                    if (error.code === error.PERMISSION_DENIED) {
                        message = "Você negou o acesso à localização. Habilite-o nas configurações do navegador.";
                    }
                    showPushNotification(message, "error", 5000);
                }, {
                    enableHighAccuracy: true, // Pede a localização mais precisa possível
                    timeout: 10000, // Tempo máximo para obter a localização (10s)
                    maximumAge: 0 // Força a obtenção de uma nova localização
                }
            );
        }

        /**
         * Alterna entre os painéis de busca de corrida e status.
         * @param {boolean} isSearching - Se está no estado de busca.
         */
        function toggleSearchingState(isSearching) {
            if (isSearching) {
                switchPanel('ride-status-panel');
            } else {
                switchPanel('ride-request-panel');
            }
        }

        // As funções de autenticação do Firebase (updateAuthUI, handleAuthError) foram comentadas
        // pois a integração com o Firebase está desativada temporariamente.

        // Eventos dos botões
        dom.submitButton.addEventListener('click', () => {
            if (currentOrigin && currentDestination) {
                switchPanel('vehicle-selection-panel');
                currentSelectionMode = null; // Desativa a seleção do mapa ao avançar
            }
        });

        dom.clearButton.addEventListener('click', clearFieldsAndMap);

        dom.currentLocationButton.addEventListener('click', handleCurrentLocation);

        dom.selectOriginButton.addEventListener('click', () => {
            currentSelectionMode = 'origin';
            toggleMapVisibility(true);
        });

        dom.selectDestinationButton.addEventListener('click', () => {
            currentSelectionMode = 'destination';
            toggleMapVisibility(true);
        });

        dom.vehicleButtons.forEach(button => {
            button.addEventListener('click', () => {
                const vehicleType = button.dataset.vehicle;
                const estimatedPrice = estimateFare(tripData.distance, vehicleType);
                
                tripData.vehicle = vehicleType;
                tripData.fare = estimatedPrice;
                
                dom.statusMessage.textContent = `Procurando ${vehicleType} disponível...`;
                dom.statusDistance.textContent = `Distância: ${tripData.distance.toFixed(2)} km | Tempo: ${formatTime(tripData.time)}`;
                dom.statusPrice.textContent = `Preço estimado: ${estimatedPrice}`;
                
                // Formata os endereços para exibição
                if (currentOrigin && currentOrigin.data) {
                    dom.statusOriginText.textContent = currentOrigin.data.display_name;
                }
                if (currentDestination && currentDestination.data) {
                    dom.statusDestinationText.textContent = currentDestination.data.display_name;
                }
                
                toggleSearchingState(true);
            });
        });

        dom.backToFormButton.addEventListener('click', () => {
            switchPanel('ride-request-panel');
        });
        
        // Evento para o botão de cancelar a corrida
        dom.cancelButton.addEventListener('click', () => {
            toggleSearchingState(false); // Retorna ao estado inicial
            clearFieldsAndMap();
        });

        // Eventos para autocompletar endereço
        dom.originInput.addEventListener('input', debounce((e) => {
            fetchAndDisplaySuggestions(e.target, dom.originSuggestions);
        }, 300));

        dom.destinationInput.addEventListener('input', debounce((e) => {
            fetchAndDisplaySuggestions(e.target, dom.destinationSuggestions);
        }, 300));

        // Oculta as sugestões ao clicar fora dos campos e das listas de sugestões
        document.addEventListener('click', (e) => {
            if (!dom.originInput.contains(e.target) && !dom.originSuggestions.contains(e.target)) {
                dom.originSuggestions.style.display = 'none';
            }
            if (!dom.destinationInput.contains(e.target) && !dom.destinationSuggestions.contains(e.target)) {
                dom.destinationSuggestions.style.display = 'none';
            }
        });

        // Eventos do modal de login
        dom.closeModalButton.addEventListener('click', () => {
            dom.loginModal.classList.remove('visible');
            dom.loginErrorMessage.textContent = '';
        });

        dom.loginButton.addEventListener('click', () => {
            // A lógica de login com Firebase foi comentada.
            // const phone = dom.loginPhoneInput.value;
            // const password = dom.loginPasswordInput.value;
            // ...
            showPushNotification("Função de login temporariamente desativada.", "info");
        });

        // Este botão agora abre o modal de cadastro
        dom.goToRegisterButton.addEventListener('click', () => {
            dom.loginModal.classList.remove('visible');
            dom.registerModal.classList.add('visible');
            dom.loginErrorMessage.textContent = ''; // Limpa erros anteriores
        });

        dom.forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            dom.loginModal.classList.remove('visible');
            dom.forgotPasswordModal.classList.add('visible');
            dom.loginErrorMessage.textContent = '';
        });

        // --- Eventos do Modal de Cadastro ---

        dom.closeRegisterModalButton.addEventListener('click', () => {
            dom.registerModal.classList.remove('visible');
            dom.registerErrorMessage.textContent = '';
        });

        dom.backToLoginButton.addEventListener('click', () => {
            dom.registerModal.classList.remove('visible');
            dom.loginModal.classList.add('visible');
            dom.registerErrorMessage.textContent = ''; // Limpa erros anteriores
        });

        dom.createAccountButton.addEventListener('click', () => {
            const name = dom.registerNameInput.value.trim();
            const phone = dom.registerPhoneInput.value.trim();
            const password = dom.registerPasswordInput.value;
            const confirmPassword = dom.registerConfirmPasswordInput.value;
            
            dom.registerErrorMessage.textContent = ''; // Limpa erros anteriores

            if (!name || !phone) {
                dom.registerErrorMessage.textContent = 'Nome e telefone são obrigatórios.';
                return;
            }
            if (password.length < 6) {
                dom.registerErrorMessage.textContent = 'A senha deve ter no mínimo 6 caracteres.';
                return;
            }
            if (password !== confirmPassword) {
                dom.registerErrorMessage.textContent = 'As senhas não coincidem.';
                return;
            }

            // Se a validação passar
            showPushNotification("Função de cadastro temporariamente desativada.", "info");
        });

        // --- Eventos do Modal de Recuperação de Senha (Novo) ---

        dom.closeForgotModalButton.addEventListener('click', () => {
            dom.forgotPasswordModal.classList.remove('visible');
            dom.forgotErrorMessage.textContent = '';
        });

        dom.backToLoginFromForgotButton.addEventListener('click', () => {
            dom.forgotPasswordModal.classList.remove('visible');
            dom.loginModal.classList.add('visible');
            dom.forgotErrorMessage.textContent = '';
        });

        dom.sendCodeButton.addEventListener('click', () => {
            const phone = dom.forgotPhoneInput.value.trim();
            dom.forgotErrorMessage.textContent = '';

            if (!phone) {
                dom.forgotErrorMessage.textContent = 'Por favor, insira seu número de telefone.';
                return;
            }

            // Lógica para enviar o código SMS (desativada por enquanto)
            showPushNotification(`Um código de verificação foi enviado para ${phone}.`, 'info');
            
            // Transição para o modal de verificação
            dom.forgotPasswordModal.classList.remove('visible');
            dom.verifyCodeModal.classList.add('visible');
        });

        // --- Eventos do Modal de Verificação de Código (Novo) ---

        dom.closeVerifyModalButton.addEventListener('click', () => {
            dom.verifyCodeModal.classList.remove('visible');
            dom.verifyErrorMessage.textContent = '';
        });

        dom.backToLoginFromVerifyButton.addEventListener('click', () => {
            dom.verifyCodeModal.classList.remove('visible');
            dom.loginModal.classList.add('visible');
            dom.verifyErrorMessage.textContent = '';
        });

        dom.resetPasswordButton.addEventListener('click', () => {
            const code = dom.verifyCodeInput.value.trim();
            const newPassword = dom.newPasswordInput.value;
            const confirmNewPassword = dom.confirmNewPasswordInput.value;

            dom.verifyErrorMessage.textContent = '';

            if (code.length !== 6 || !/^\d+$/.test(code)) {
                dom.verifyErrorMessage.textContent = 'O código de verificação deve ter 6 dígitos.';
                return;
            }
            if (newPassword.length < 6) {
                dom.verifyErrorMessage.textContent = 'A nova senha deve ter no mínimo 6 caracteres.';
                return;
            }
            if (newPassword !== confirmNewPassword) {
                dom.verifyErrorMessage.textContent = 'As novas senhas não coincidem.';
                return;
            }

            // Lógica para redefinir a senha (desativada por enquanto)
            showPushNotification('Senha redefinida com sucesso!', 'success');
            
            // Limpa os campos e volta para o login
            dom.verifyCodeInput.value = '';
            dom.newPasswordInput.value = '';
            dom.confirmNewPasswordInput.value = '';
            dom.verifyCodeModal.classList.remove('visible');
            dom.loginModal.classList.add('visible');
        });

        // Adiciona o evento para abrir o modal diretamente, já que o Firebase está desativado
        dom.authButton.addEventListener('click', () => {
            dom.loginModal.classList.add('visible');
        });

        // Inicialização do aplicativo
        window.onload = function() {
            // Lógica para carregar o tema
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Se houver um tema salvo, use-o. Caso contrário, use a preferência do sistema.
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
            
            // Carrega a logo correta baseada no tema inicial
            const logoElement = document.querySelector('h1 img');
            if (logoElement) {
                const isDark = document.body.classList.contains('dark');
                logoElement.src = isDark ? 'logodark.png' : 'logo.png';
                logoElement.alt = isDark ? 'Logo Via Já (Tema Escuro)' : 'Logo Vi Já';
            }
            
             // Listener para o botão de tema
            dom.themeToggle.addEventListener('click', toggleTheme);
            
            // Tenta obter a localização por IP primeiro para centralizar o mapa.
            // A localização precisa via GPS será obtida apenas ao clicar no botão.
            fetch('https://get.geojs.io/v1/ip/geo.json')
                .then(response => response.json())
                .then(data => {
                    // A API GeoJS.io retorna latitude e longitude diretamente.
                    if (data && data.latitude && data.longitude) {
                        const latitude = parseFloat(data.latitude);
                        const longitude = parseFloat(data.longitude);
                        initializeMap(latitude, longitude);
                    } else {
                         throw new Error('Localização por IP não disponível via GeoJS.io');
                    }
                })
                .catch(error => {
                    console.error("Erro ao obter a localização por IP:", error);
                    showPushNotification("Não foi possível obter a localização por IP. Usando localização padrão.", "warning", 4000);
                    initializeMap(-18.5807, -46.5160); // Padrão: Patos de Minas, MG
                });
        };

        // Registra o Service Worker para funcionalidades PWA (offline)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registrado com sucesso: ', registration.scope);
                }).catch(error => {
                    console.log('Falha ao registrar o ServiceWorker: ', error);
                });
            });
        }
    </script>
</body>
</html>
